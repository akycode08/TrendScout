–ü—Ä–∏–≤–µ—Ç! –Ø –Ω–æ–≤–∏—á–æ–∫ –≤ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏ —Å–æ–∑–¥–∞—é –ø—Ä–æ–µ–∫—Ç TrendScout –Ω–∞ Python 3.11+ - —Å–∏—Å—Ç–µ–º—É –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –≤–∏—Ä—É—Å–Ω—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞.

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å –º–æ–π –∫–æ–¥ –∏ –¥–∞–π –¥–µ—Ç–∞–ª—å–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å:

1. **–ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–æ–¥–∞** - –µ—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∏, –±–∞–≥–∏, –ø—Ä–æ–±–ª–µ–º—ã?
2. **–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞** - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –∫–æ–¥ best practices Python?
3. **–û–±—É—á–µ–Ω–∏–µ** - —á—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –∏ –ø–æ—á–µ–º—É? –û–±—ä—è—Å–Ω–∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏.
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –µ—Å—Ç—å –ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é?
5. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –º–æ–∂–Ω–æ –ª–∏ —á—Ç–æ-—Ç–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å?
6. **Async/await** - –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —è –∏—Å–ø–æ–ª—å–∑—É—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ?

–û—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–æ–≤–µ—Ä—å —ç—Ç–∏ —Ñ–∞–π–ª—ã:

=== –§–ê–ô–õ 1: Google Trends –∫–æ–ª–ª–µ–∫—Ç–æ—Ä ===

```python
"""
Google Trends –∫–æ–ª–ª–µ–∫—Ç–æ—Ä

–°–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ —Ç—Ä–µ–Ω–¥–∞—Ö –∏–∑ Google Trends.
–≠—Ç–æ —Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –∫–æ–ª–ª–µ–∫—Ç–æ—Ä - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç API –∫–ª—é—á–µ–π!

pytrends - —ç—Ç–æ –Ω–µ–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Trends.
–û–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∫–ª—é—á–µ–π, –Ω–æ –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ —á–∞—Å—Ç–æ—Ç–µ –∑–∞–ø—Ä–æ—Å–æ–≤.
"""

import asyncio
from typing import List, Dict, Any
from datetime import datetime
from pytrends.request import TrendReq

from data_collectors.base_collector import BaseCollector
from config import get_vertical_keywords


class GoogleTrendsCollector(BaseCollector):
    """
    –ö–æ–ª–ª–µ–∫—Ç–æ—Ä –¥–ª—è Google Trends
    
    –°–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π.
    """
    
    def __init__(self):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–ª–ª–µ–∫—Ç–æ—Ä–∞
        
        TrendReq - —ç—Ç–æ –∫–ª–∞—Å—Å –∏–∑ pytrends –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Trends API
        hl='en-US' - —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        tz=360 - —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å (360 = UTC-6, –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å)
        """
        super().__init__()
        # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Trends
        # –≠—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞, –Ω–æ –º—ã –æ–±–µ—Ä–Ω–µ–º –µ—ë –≤ async
        self.pytrends = TrendReq(hl='en-US', tz=360)
    
    async def collect(self, vertical: str, **kwargs) -> List[Dict[str, Any]]:
        """
        –°–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Google Trends
        
        Args:
            vertical: –¢–∏–ø –±–∏–∑–Ω–µ—Å–∞ (coffee, restaurant, etc.)
            **kwargs: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            
        Returns:
            List[Dict]: –°–ø–∏—Å–æ–∫ —Ç—Ä–µ–Ω–¥–æ–≤ –≤ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
        """
        print(f"üìä –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Trends –¥–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª–∏: {vertical}")
        
        # –ü–æ–ª—É—á–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —ç—Ç–æ–π –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
        keywords = get_vertical_keywords(vertical)
        print(f"   –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: {', '.join(keywords[:5])}...")
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ, —Ç.–∫. pytrends —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π
        # –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –∑–∞–¥–∞—á–∏
        loop = asyncio.get_event_loop()
        results = await loop.run_in_executor(
            None, 
            self._collect_sync, 
            keywords
        )
        
        print(f"‚úÖ –°–æ–±—Ä–∞–Ω–æ {len(results)} —Ç—Ä–µ–Ω–¥–æ–≤ –∏–∑ Google Trends")
        return results
    
    def _collect_sync(self, keywords: List[str]) -> List[Dict[str, Any]]:
        """
        –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
        
        –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ,
        —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å async –∫–æ–¥.
        
        Args:
            keywords: –°–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞
            
        Returns:
            List[Dict]: –°–ø–∏—Å–æ–∫ —Ç—Ä–µ–Ω–¥–æ–≤
        """
        results = []
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –≥—Ä—É–ø–ø–∞–º–∏ –ø–æ 5
        # Google Trends –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–∫–∞—Ç—å –¥–æ 5 –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
        for i in range(0, len(keywords), 5):
            keyword_batch = keywords[i:i+5]
            
            try:
                # –°—Ç—Ä–æ–∏–º –∑–∞–ø—Ä–æ—Å –∫ Google Trends
                self.pytrends.build_payload(
                    keyword_batch,      # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
                    cat=0,              # –ö–∞—Ç–µ–≥–æ—Ä–∏—è (0 = –≤—Å–µ)
                    timeframe='now 7-d', # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
                    geo='US'            # –ì–µ–æ–≥—Ä–∞—Ñ–∏—è (US = –°–®–ê)
                )
                
                # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–± –∏–Ω—Ç–µ—Ä–µ—Å–µ –∑–∞ –≤—Ä–µ–º—è
                interest_df = self.pytrends.interest_over_time()
                
                # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã
                if not interest_df.empty:
                    for keyword in keyword_batch:
                        if keyword in interest_df.columns:
                            # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (—Å–∞–º–æ–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ)
                            interest_score = int(interest_df[keyword].iloc[-1])
                            
                            # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
                            normalized = self.normalize_data({
                                'id': f"gt_{keyword}_{datetime.now().timestamp()}",
                                'text': keyword,
                                'content': f"Google Trends: {keyword}",
                                'url': f"https://trends.google.com/trends/explore?q={keyword}",
                                'playCount': interest_score * 1000,  # –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∏—Å–∫–æ–≤
                                'diggCount': 0,  # Google Trends –Ω–µ –∏–º–µ–µ—Ç –ª–∞–π–∫–æ–≤
                                'commentCount': 0,
                                'shareCount': 0,
                                'createTime': datetime.now(),
                                'posted_at': datetime.now()
                            })
                            
                            # –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è Google Trends –ø–æ–ª—è
                            normalized['interest_score'] = interest_score
                            normalized['is_breakout'] = interest_score > 80
                            
                            results.append(normalized)
                
                # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                # Google Trends –º–æ–∂–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
                import time
                time.sleep(1)
                
            except Exception as e:
                print(f"‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è {keyword_batch}: {e}")
                continue
        
        return results
```

=== –§–ê–ô–õ 2: –§–∏–ª—å—Ç—Ä –¥–∞–Ω–Ω—ã—Ö ===

```python
"""
–§–∏–ª—å—Ç—Ä –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –∫–æ–ª–ª–µ–∫—Ç–æ—Ä–æ–≤:
1. –£–¥–∞–ª—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã
2. –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ (—É–±–∏—Ä–∞–µ—Ç –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –ø–æ—Å—Ç—ã)
3. –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö
"""

from typing import List, Dict, Any
from datetime import datetime
from collections import defaultdict


class DataFilter:
    """
    –ö–ª–∞—Å—Å –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
    
    –í—Å–µ –º–µ—Ç–æ–¥—ã —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ - –º—ã –Ω–µ —Å–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –∫–ª–∞—Å—Å–∞,
    –∞ –≤—ã–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥—ã –Ω–∞–ø—Ä—è–º—É—é: DataFilter.filter_and_normalize(...)
    """
    
    @staticmethod
    def filter_and_normalize(
        raw_data: List[Dict[str, Any]], 
        vertical: str = "coffee"
    ) -> List[Dict[str, Any]]:
        """
        –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
        
        Args:
            raw_data: –°–ø–∏—Å–æ–∫ —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ—Ç –∫–æ–ª–ª–µ–∫—Ç–æ—Ä–æ–≤
            vertical: –¢–∏–ø –±–∏–∑–Ω–µ—Å–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
            
        Returns:
            List[Dict]: –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        """
        print(f"üîç –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª–∏: {vertical}")
        print(f"   –í—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: {len(raw_data)}")
        
        # 1. –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
        unique_data = DataFilter._remove_duplicates(raw_data)
        print(f"   –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: {len(unique_data)}")
        
        # 2. –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç
        normalized_data = DataFilter._normalize_format(unique_data)
        
        # 3. –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ (–±–∞–∑–æ–≤–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è)
        filtered_data = DataFilter._filter_by_vertical(normalized_data, vertical)
        print(f"   –ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏: {len(filtered_data)}")
        
        # 4. –£–¥–∞–ª—è–µ–º –ø–æ—Å—Ç—ã —Å –Ω—É–ª–µ–≤—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏ (—Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –æ—à–∏–±–∫–∞)
        filtered_data = DataFilter._remove_empty_posts(filtered_data)
        print(f"   –§–∏–Ω–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: {len(filtered_data)}")
        
        return filtered_data
    
    @staticmethod
    def _remove_duplicates(data: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
        """
        –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ—Å—Ç–æ–≤
        
        –î—É–±–ª–∏–∫–∞—Ç—ã –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø–æ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ platform + post_id
        
        Args:
            data: –°–ø–∏—Å–æ–∫ –¥–∞–Ω–Ω—ã—Ö
            
        Returns:
            List[Dict]: –î–∞–Ω–Ω—ã–µ –±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
        """
        seen = set()
        unique_data = []
        
        for item in data:
            # –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –∏–∑ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –∏ ID –ø–æ—Å—Ç–∞
            key = (item.get('platform', ''), item.get('post_id', ''))
            
            if key not in seen and key[0] and key[1]:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª—é—á –Ω–µ –ø—É—Å—Ç–æ–π
                seen.add(key)
                unique_data.append(item)
        
        return unique_data
    
    @staticmethod
    def _normalize_format(data: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
        """
        –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö
        
        –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø –∏ —Ñ–æ—Ä–º–∞—Ç
        
        Args:
            data: –°–ø–∏—Å–æ–∫ –¥–∞–Ω–Ω—ã—Ö
            
        Returns:
            List[Dict]: –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        """
        normalized = []
        
        for item in data:
            try:
                normalized_item = {
                    'platform': str(item.get('platform', 'unknown')),
                    'post_id': str(item.get('post_id', '')),
                    'content': str(item.get('content', '')),
                    'url': str(item.get('url', '')),
                    'views': int(item.get('views', 0)),
                    'likes': int(item.get('likes', 0)),
                    'comments': int(item.get('comments', 0)),
                    'shares': int(item.get('shares', 0)),
                    'posted_at': item.get('posted_at', datetime.now()),
                    'collected_at': datetime.now()
                }
                
                # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                if 'interest_score' in item:
                    normalized_item['interest_score'] = item['interest_score']
                if 'is_breakout' in item:
                    normalized_item['is_breakout'] = item['is_breakout']
                
                normalized.append(normalized_item)
                
            except (ValueError, TypeError) as e:
                # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                print(f"‚ö†Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç: {e}")
                continue
        
        return normalized
    
    @staticmethod
    def _filter_by_vertical(
        data: List[Dict[str, Any]], 
        vertical: str
    ) -> List[Dict[str, Any]]:
        """
        –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
        
        –ë–∞–∑–æ–≤–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ.
        –í –±—É–¥—É—â–µ–º —ç—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å —Å –ø–æ–º–æ—â—å—é AI.
        
        Args:
            data: –°–ø–∏—Å–æ–∫ –¥–∞–Ω–Ω—ã—Ö
            vertical: –¢–∏–ø –±–∏–∑–Ω–µ—Å–∞
            
        Returns:
            List[Dict]: –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        """
        from config import get_vertical_keywords
        
        # –ü–æ–ª—É—á–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
        keywords = get_vertical_keywords(vertical)
        keywords_lower = [kw.lower() for kw in keywords]
        
        filtered = []
        
        for item in data:
            content = item.get('content', '').lower()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ
            if any(keyword in content for keyword in keywords_lower):
                filtered.append(item)
            # –î–ª—è Google Trends –≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–µ–º (—Ç–∞–º —É–∂–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º)
            elif item.get('platform') == 'google_trends':
                filtered.append(item)
        
        return filtered
    
    @staticmethod
    def _remove_empty_posts(data: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
        """
        –£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç—ã —Å –Ω—É–ª–µ–≤—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏
        
        Args:
            data: –°–ø–∏—Å–æ–∫ –¥–∞–Ω–Ω—ã—Ö
            
        Returns:
            List[Dict]: –î–∞–Ω–Ω—ã–µ –±–µ–∑ –ø—É—Å—Ç—ã—Ö –ø–æ—Å—Ç–æ–≤
        """
        filtered = []
        
        for item in data:
            # –î–ª—è Google Trends –∏—Å–ø–æ–ª—å–∑—É–µ–º interest_score –≤–º–µ—Å—Ç–æ views
            if item.get('platform') == 'google_trends':
                if item.get('interest_score', 0) > 0:
                    filtered.append(item)
            else:
                # –î–ª—è –¥—Ä—É–≥–∏—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º –ø—Ä–æ–≤–µ—Ä—è–µ–º views
                if item.get('views', 0) > 0:
                    filtered.append(item)
        
        return filtered
```

=== –§–ê–ô–õ 3: –ú–æ–¥–µ–ª–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö ===

```python
"""
–ú–æ–¥–µ–ª–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–ú–æ–¥–µ–ª—å - —ç—Ç–æ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
SQLAlchemy –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–∏—Ö –º–æ–¥–µ–ª–µ–π.

–£ –Ω–∞—Å 3 –æ—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥–µ–ª–∏:
1. Trend - —Ç—Ä–µ–Ω–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Lavender Oat Milk Latte")
2. Post - –ø–æ—Å—Ç –∏–∑ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π
3. BusinessIdea - –±–∏–∑–Ω–µ—Å-–∏–¥–µ—è –¥–ª—è —Ç—Ä–µ–Ω–¥–∞
"""

from datetime import datetime
from sqlalchemy import Column, Integer, String, Float, DateTime, ForeignKey, Text, JSON
from sqlalchemy.orm import relationship

from database.db import Base


class Trend(Base):
    """
    –ú–æ–¥–µ–ª—å —Ç—Ä–µ–Ω–¥–∞
    
    –•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏—Ä—É—Å–Ω–æ–º —Ç—Ä–µ–Ω–¥–µ (–Ω–∞–ø–∏—Ç–æ–∫, –±–ª—é–¥–æ –∏ —Ç.–¥.)
    """
    __tablename__ = "trends"  # –ò–º—è —Ç–∞–±–ª–∏—Ü—ã –≤ –ë–î
    
    # –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è
    id = Column(Integer, primary_key=True, index=True)
    trend_name = Column(String(255), nullable=False)
    category = Column(String(100))  # "coffee_drink", "pastry", etc.
    vertical = Column(String(50))   # "coffee", "restaurant", etc.
    
    # –û—Ü–µ–Ω–∫–∏ (scores)
    uts_score = Column(Float)           # Universal Trend Score (0-100)
    velocity_score = Column(Float)      # –°–∫–æ—Ä–æ—Å—Ç—å —Ä–æ—Å—Ç–∞
    momentum_score = Column(Float)      # –ò–º–ø—É–ª—å—Å (–ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å–∞)
    engagement_score = Column(Float)    # –í–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å –∞—É–¥–∏—Ç–æ—Ä–∏–∏
    
    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    first_seen = Column(DateTime, default=datetime.utcnow)
    last_updated = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    status = Column(String(50))  # "rising", "peak", "declining"
    
    # AI –∞–Ω–∞–ª–∏–∑
    description = Column(Text)          # –û–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–Ω–¥–∞ –æ—Ç AI
    sentiment = Column(String(20))      # "positive", "negative", "neutral"
    ai_confidence = Column(Float)       # –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å AI (0-1)
    
    # –°–≤—è–∑–∏ —Å –¥—Ä—É–≥–∏–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏
    posts = relationship("Post", back_populates="trend")
    business_idea = relationship("BusinessIdea", back_populates="trend", uselist=False)
    
    def __repr__(self):
        return f"<Trend(id={self.id}, name='{self.trend_name}', score={self.uts_score})>"


class Post(Base):
    """
    –ú–æ–¥–µ–ª—å –ø–æ—Å—Ç–∞ –∏–∑ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π
    """
    __tablename__ = "posts"
    
    id = Column(Integer, primary_key=True, index=True)
    platform = Column(String(50), nullable=False)
    post_id = Column(String(255), unique=True)
    content = Column(Text)
    url = Column(String(500))
    
    # –ú–µ—Ç—Ä–∏–∫–∏
    views = Column(Integer, default=0)
    likes = Column(Integer, default=0)
    comments = Column(Integer, default=0)
    shares = Column(Integer, default=0)
    
    # –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
    posted_at = Column(DateTime)
    collected_at = Column(DateTime, default=datetime.utcnow)
    
    # –°–≤—è–∑—å —Å —Ç—Ä–µ–Ω–¥–æ–º
    trend_id = Column(Integer, ForeignKey("trends.id"), nullable=True)
    trend = relationship("Trend", back_populates="posts")
    
    def __repr__(self):
        return f"<Post(id={self.id}, platform='{self.platform}', views={self.views})>"


class BusinessIdea(Base):
    """
    –ú–æ–¥–µ–ª—å –±–∏–∑–Ω–µ—Å-–∏–¥–µ–∏
    """
    __tablename__ = "business_ideas"
    
    id = Column(Integer, primary_key=True, index=True)
    trend_id = Column(Integer, ForeignKey("trends.id"), unique=True)
    trend = relationship("Trend", back_populates="business_idea")
    
    vertical = Column(String(50))
    
    # –†–µ—Ü–µ–ø—Ç/–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
    recipe_instructions = Column(Text)
    ingredients = Column(JSON)
    equipment_needed = Column(JSON)
    
    # –ë–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∏
    suggested_price = Column(Float)
    cost_estimate = Column(Float)
    margin_percent = Column(Float)
    roi_projection = Column(String(100))
    
    # –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥
    marketing_caption = Column(Text)
    hashtags = Column(JSON)
    
    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    generated_at = Column(DateTime, default=datetime.utcnow)
    
    def __repr__(self):
        return f"<BusinessIdea(id={self.id}, trend_id={self.trend_id}, price=${self.suggested_price})>"
```

=== –§–ê–ô–õ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===

```python
"""
–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è TrendScout

–≠—Ç–æ—Ç —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env —Ñ–∞–π–ª–∞
–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —É–¥–æ–±–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º —á–µ—Ä–µ–∑ –∫–ª–∞—Å—Å Settings.
"""

import os
from typing import Optional
from pydantic_settings import BaseSettings
from pydantic import Field


class Settings(BaseSettings):
    """
    –ö–ª–∞—Å—Å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    
    Pydantic –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏—Ö —Ç–∏–ø—ã.
    """
    
    # API Keys
    apify_api_key: str = Field(..., alias="APIFY_API_KEY")
    anthropic_api_key: str = Field(..., alias="ANTHROPIC_API_KEY")
    youtube_api_key: str = Field(..., alias="YOUTUBE_API_KEY")
    openai_api_key: Optional[str] = Field(None, alias="OPENAI_API_KEY")
    
    # Reddit API
    reddit_client_id: str = Field(..., alias="REDDIT_CLIENT_ID")
    reddit_client_secret: str = Field(..., alias="REDDIT_CLIENT_SECRET")
    reddit_user_agent: str = Field("TrendScout/1.0", alias="REDDIT_USER_AGENT")
    
    # Database
    database_url: str = Field("sqlite:///./trendscout.db", alias="DATABASE_URL")
    
    # General Settings
    vertical: str = Field("coffee", alias="VERTICAL")
    debug: bool = Field(True, alias="DEBUG")
    log_level: str = Field("INFO", alias="LOG_LEVEL")
    
    class Config:
        env_file = ".env"  # –ß–∏—Ç–∞—Ç—å –∏–∑ .env —Ñ–∞–π–ª–∞
        env_file_encoding = "utf-8"
        case_sensitive = False


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫
_settings: Optional[Settings] = None


def get_settings() -> Settings:
    """
    –ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (singleton pattern).
    
    Returns:
        Settings: –≠–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫
    """
    global _settings
    if _settings is None:
        _settings = Settings()
    return _settings
```

---

**–í–æ–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**

1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —è –∏—Å–ø–æ–ª—å–∑—É—é `run_in_executor` –≤ Google Trends –∫–æ–ª–ª–µ–∫—Ç–æ—Ä–µ? –ï—Å—Ç—å –ª–∏ –ª—É—á—à–∏–π —Å–ø–æ—Å–æ–±?
2. –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞ –ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫? –ù–µ —Ç–µ—Ä—è—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö?
3. –ú–æ–∂–Ω–æ –ª–∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö? –û—Å–æ–±–µ–Ω–Ω–æ `_filter_by_vertical`?
4. –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —Å–≤—è–∑–∏ –≤ –º–æ–¥–µ–ª—è—Ö –ë–î? –ï—Å—Ç—å –ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å `relationship`?
5. –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `Field(..., alias="...")` –≤ Pydantic? –ù–µ –±—É–¥–µ—Ç –ª–∏ –ø—Ä–æ–±–ª–µ–º, –µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ –∑–∞–¥–∞–Ω–∞?
6. –ï—Å—Ç—å –ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é? –û—Å–æ–±–µ–Ω–Ω–æ –≤ —Ü–∏–∫–ª–∞—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö?
7. –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —è –∏—Å–ø–æ–ª—å–∑—É—é —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–æ–¥—ã –≤ DataFilter? –ï—Å—Ç—å –ª–∏ —Å–º—ã—Å–ª —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ –∫–ª–∞—Å—Å–æ–º —Å —ç–∫–∑–µ–º–ø–ª—è—Ä–∞–º–∏?

–î–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —á—Ç–æ-—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å. –û–±—ä—è—Å–Ω–∏ –ø–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –Ω–æ–≤–∏—á–∫–∞.

